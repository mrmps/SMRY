# Validation Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Request to /api/article                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Validate Request     â”‚
                  â”‚ (ArticleRequestSchema)â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Check Cache (KV)     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                             â”‚
              â–¼ Cache Hit                   â–¼ Cache Miss
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Validate Cached Data â”‚      â”‚ Fetch from Diffbot   â”‚
   â”‚ (CachedArticleSchema)â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
              â”‚                             â–¼
              â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚   lib/api/diffbot.ts         â”‚
              â”‚              â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
              â”‚              â”‚   â”‚ 1. Validate HTTP       â”‚ â”‚
              â”‚              â”‚   â”‚    Response Structure  â”‚ â”‚
              â”‚              â”‚   â”‚    (DiffbotArticle     â”‚ â”‚
              â”‚              â”‚   â”‚     ResponseSchema)    â”‚ â”‚
              â”‚              â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
              â”‚              â”‚              â”‚               â”‚
              â”‚              â”‚              â–¼               â”‚
              â”‚              â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
              â”‚              â”‚   â”‚ 2. Try Diffbot Extractâ”‚ â”‚
              â”‚              â”‚   â”‚    - New Format       â”‚ â”‚
              â”‚              â”‚   â”‚    - Old Format       â”‚ â”‚
              â”‚              â”‚   â”‚    Validate each with â”‚ â”‚
              â”‚              â”‚   â”‚    DiffbotArticle     â”‚ â”‚
              â”‚              â”‚   â”‚    Schema             â”‚ â”‚
              â”‚              â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
              â”‚              â”‚              â”‚               â”‚
              â”‚              â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
              â”‚              â”‚   â”‚ Success? â”‚   Failed?   â”‚ â”‚
              â”‚              â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
              â”‚              â”‚          â”‚       â”‚           â”‚
              â”‚              â”‚          â”‚       â–¼           â”‚
              â”‚              â”‚          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
              â”‚              â”‚          â”‚   â”‚ 3. Fallback â”‚ â”‚
              â”‚              â”‚          â”‚   â”‚    Readabilityâ”‚ â”‚
              â”‚              â”‚          â”‚   â”‚    Extract  â”‚ â”‚
              â”‚              â”‚          â”‚   â”‚    Validate: â”‚ â”‚
              â”‚              â”‚          â”‚   â”‚    - Readabilityâ”‚
              â”‚              â”‚          â”‚   â”‚      Article â”‚ â”‚
              â”‚              â”‚          â”‚   â”‚      Schema  â”‚ â”‚
              â”‚              â”‚          â”‚   â”‚    - Final   â”‚ â”‚
              â”‚              â”‚          â”‚   â”‚      Diffbot â”‚ â”‚
              â”‚              â”‚          â”‚   â”‚      Article â”‚ â”‚
              â”‚              â”‚          â”‚   â”‚      Schema  â”‚ â”‚
              â”‚              â”‚          â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚
              â”‚              â”‚          â”‚          â”‚        â”‚
              â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                         â”‚
              â”‚                         â–¼
              â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚ Validate Diffbot     â”‚
              â”‚              â”‚ Response             â”‚
              â”‚              â”‚ (DiffbotArticleSchema)â”‚
              â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Save to Cache        â”‚
                  â”‚ - Validate incoming  â”‚
                  â”‚ - Validate existing  â”‚
                  â”‚ - Validate saved     â”‚
                  â”‚ (CachedArticleSchema)â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Validate Final       â”‚
                  â”‚ Response             â”‚
                  â”‚ (ArticleResponseSchema)â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Return to Client     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LEGEND:
  Every box with "Validate" = Zod schema validation with safeParse()
  All validation failures are logged with detailed context
  Failed validations trigger fallbacks or return errors
```

## Validation Coverage Summary

### ğŸ”’ **13 Validation Points Total**

#### In `lib/api/diffbot.ts` (7 points)
1. âœ… Raw Diffbot API response structure
2. âœ… Diffbot article extraction (new format)
3. âœ… Diffbot article extraction (old format)
4. âœ… Readability targeted container result
5. âœ… Readability full document result
6. âœ… Final Readability result before resolve
7. âœ… All article objects before returning

#### In `app/api/article/route.ts` (6 points)
1. âœ… Diffbot function response
2. âœ… Cached article on read
3. âœ… Incoming article before cache save
4. âœ… Existing cached article
5. âœ… Saved article after cache operation
6. âœ… Article in error handler

### ğŸ›¡ï¸ **100% Coverage**
Every data transformation point is validated
Every external API response is validated  
Every cache read/write is validated
Every return path is validated

